<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="bootstrap/bootstrap.min.css">
		<link rel="stylesheet" href="bootstrap/bootstrap-theme.min.css">
		<script src="js/BigInteger.min.js"></script>
		<script src="js/jquery-3.3.1.min.js"></script>
		<script src="js/aes.js"></script>
		<script src="js/jspack.js"></script>
		<script src="bootstrap/bootstrap.min.js"></script>
		<script src="rollups/aes.js"></script>
		<script type="text/javascript" src="lib/cryptojs-aes.min.js"></script>
		<script type="text/javascript" src="build/cmac.js"></script>
		<script>
			function d2h(d) {
				return (d / 256 + 1 / 512).toString(16).substring(2, 4);
			}
		
			function u32(x) {
				return bigInt(x).and(0xFFFFFFFF)
			}

			class sead_rand {
				constructor(states) {
					this.state = []
					for(var i = 1; i < 5; i++){
						this.state[i-1] = states[i-1]
					}
				}

				get_u32() {
					var a = u32(bigInt(this.state[0]).xor(bigInt(this.state[0]).shiftLeft(11)))
					this.state[0] = this.state[1]
					var b = u32(this.state[3])
					var c = u32(bigInt(a).xor((bigInt(a).shiftRight(8))).xor(b).xor(bigInt(b).shiftRight(19)))
					this.state[1] = this.state[2]
					this.state[2] = b
					this.state[3] = c
					return c
				}
			}
			
			function handleFileSelect() {               
				if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
					alert('The File APIs are not fully supported in this browser.');
					return;
				}   

				input = document.getElementById('fileinput');
				if (!input) {
					alert("Um, couldn't find the fileinput element.");
				}
				else if (!input.files) {
					alert("This browser doesn't seem to support the `files` property of file inputs.");
				}
				else if (!input.files[0]) {
					alert("Please select a file before clicking 'Load'");               
				}
				else {
					file = input.files[0];
					fr = new FileReader();
					fr.onload = receivedText;
					fr.readAsArrayBuffer(file);
				}
			}
		  
			function getArray(Src, startPos, Count) {
				var endArray = []
				for(i = 0; i < Count; i++){
					endArray[i] = Src[startPos + i];	
				}
				return endArray; 
			}
		  
			function readInt32(array, startPos) {
				var newArr = [array[startPos + 3],array[startPos + 2],array[startPos + 1],array[startPos]]
				var result=0;
				for (let i=3;i>=0;i--) {
					result+=newArr[3-i]<<(8*i);
				}
				return result;
			};

			function receivedText() {
				var JSstruct = new JSPack();
				var Uint8File = new Uint8Array(fr.result);
				var MAC = getArray(Uint8File,0x000088D80, 0x10);
				var KeySeed = getArray(Uint8File,0x000088D70, 0x10);
				var IV = getArray(Uint8File,0x000088D60, 0x10);
				var body = Uint8File.slice(0x10, Uint8File.length - 0x30);
			
				rnd = new sead_rand(JSstruct.Unpack("<IIII",KeySeed,0));
			
				crypt_tab = [0xDFD0A132,  0x1537D7E5,  0xC8B0F6D5,  0x6C31FED3,  0xB7A1221A,  0x9B9DC40C,  0x44315579,  0xF239E05A,  0x87E4D9AF,  0x59EF5961,  0xF5AF2DC9,  0xD1521C02,  0x68405262,  0x9864C589,  0x98F5F8BE,  0x0C90FE24,  0x9B3FC02A,  0x31E4FD02,  0xEC747B2D,  0x5FC1C04E,  0x80D6B732,  0x32BA6CB7,  0x961A5683,  0x33025098,  0xD5676789,  0xAB622A5A,  0xF651F93A,  0x130D6D68,  0xEFFEDA48,  0x24E2C2D3,  0xEA89C5DD,  0xF04AFA58,  0x767D3A19,  0xBF67B888,  0x54218F00,  0x6F461AFF,  0x9A216E37,  0x5861AAD0,  0x3B44CEAE,  0xCD6C9A42,  0x0610ECD2,  0x2A894F76,  0x23D72BE9,  0x63FA2D93,  0x2ADC8A10,  0xFB0E9F6A,  0x3BE0CE91,  0x80BB93A1,  0xDB8D8FF3,  0x72E21DC7,  0x93B0C670,  0x2907C541,  0x3DBF1C6D,  0x62D8924F,  0x3205E36F,  0x041C44D5,  0xDACB2490,  0x01D905A9,  0x6C8C579B,  0xE3C54DC2,  0xF4583808,  0x76459488,  0x1E5F7C61,  0x2876F360]
			
				var key = []
				for (a = 0; a <= 7; a++) {
					var k = u32(0)
					for (b = 0; b <= 3; b++) {
						k = bigInt(k).shiftLeft(8)
						var firstU32 = rnd.get_u32()
						var firstShift = bigInt(firstU32).shiftRight(26)
						var cryptTab = crypt_tab[firstShift]
						var secondU32 = rnd.get_u32()
						var secondShift = bigInt(secondU32).shiftRight(27)
						var firstAnd = bigInt(secondShift).and(0x18)
						var thirdShift = bigInt(cryptTab).shiftRight(firstAnd.value)
						k = bigInt(k).or(u32(bigInt(thirdShift).and(0xFF)))
					}
					key[a] = k
				}
				
				var AESKey = JSstruct.Pack('<IIII', [key[0], key[1], key[2], key[3]])
				var MACKey = JSstruct.Pack('<IIII', [key[4], key[5], key[6], key[7]])
			
				var aesCbc = new aesjs.ModeOfOperation.cbc(AESKey, IV);
				var decryptedBytes = aesCbc.decrypt(body);
				console.log(readInt32(decryptedBytes,0x00025788 - 0x10)) // My Money
				$('#editor').html('Should be 1642280: ' + readInt32(decryptedBytes,0x00025788 - 0x10))
				
				HexDecryptedBytes = ""
				for(var i = 0; i < decryptedBytes.length; i++) {
					HexDecryptedBytes += d2h(decryptedBytes[i])
				}
		
				HexMacKey = ""
				for(var i = 0; i < 16; i++) {
					HexMacKey += d2h(MACKey[i])
				}

				var key = CryptoJS.enc.Hex.parse(HexMacKey);
				// This parse is so slow...
				var message = CryptoJS.enc.Hex.parse(HexDecryptedBytes);

				var mac = CryptoJS.CMAC(key, message);
				console.log(mac.toString());
			}
		</script>
	</head>
	<body>
		<div class="container text-center">
			<div class="row">
				<div class="col-sm-12 col-md-6 col-md-offset-2">
					<br>
					<div class="panel panel-primary">
						<div class="panel-heading">
							<h3 class="panel-title">Load Splatoon SaveFile</h3>
						</div>
						<div class="panel-body">
							<div class="row">
								<div>
									<input type="file" id="fileinput" class='form-control-file' style='display: inline-block;'>
									<br>
									<br>
									<input type="submit" class="btn btn-primary" value="Load" style="width:100px;margin:auto;" name="go" onclick='handleFileSelect();'>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="editor"></div>

	
	
	</body>
</html>